# Session Handoff: Version 27 - Independent Stem Player Controls

**Date**: 2025-10-15
**Current Branch**: experimental-v26-refactor
**Next Branch**: experimental-v27-stem-independence (create this)
**Status**: Template infrastructure complete, functionality implementation needed

---

## Context: What Was Completed in Version 26

### âœ… Template System (Infrastructure Only)
Version 26 created a template/factory system that **generates HTML** for player controls:
- `src/core/playerTemplate.js` (556 lines) - Control definitions and HTML generation
- Eliminated ~300 lines of duplicated HTML code
- All 4 stem player bars now use template-generated HTML

**IMPORTANT**: This was ONLY the HTML generation layer. The actual **functionality** for independent stem controls was NOT implemented.

### Current Stem Player Limitations
Right now, stem players have:
- âœ… Visual controls (buttons, sliders) - generated by template
- âš ï¸ Basic play/pause/mute/volume - may work but limited
- âŒ **No independent loop regions** - stems follow parent loop only
- âŒ **No independent markers** - stems follow parent markers only
- âŒ **No independent metronome** - parent metronome only
- âŒ **No independent cycle mode** - parent cycle only
- âŒ **No independent rate (unlocked)** - rate lock exists but may not be fully functional
- âŒ **No independent keyboard shortcuts** - all shortcuts affect parent only

---

## User's Original Goal (Not Yet Achieved)

**Quote**: "Taking all of the functionality we have for our bottom player and applying it to all four of the stem players."

This means each stem should have:
1. **Independent playback control** - play/pause without affecting other stems
2. **Independent loop regions** - set different loop points per stem
3. **Independent markers** - customize marker frequency and offset per stem
4. **Independent rate control** - unlock rate from parent, adjust independently
5. **Independent cycle mode** - set and play cycles per stem
6. **Independent metronome** (optional) - each stem can have its own click track
7. **Keyboard shortcuts** - shortcuts should work for selected/active stem

---

## Version 27 Goals: Implement Independent Stem Functionality

### Phase 1: Independent Playback & Rate Control
**Priority**: HIGH - Core functionality

**Current State**:
- Stem play/pause buttons call `toggleMultiStemPlay(stemType)`
- Rate lock button exists: `toggleStemRateLock(stemType)`
- Rate sliders exist: `handleStemRateChange(stemType, value)`

**What Needs Implementation**:
1. **Independent play/pause per stem**
   - Each stem can play while others are paused
   - Parent play/pause should NOT force all stems to play
   - Visual feedback: play/pause icon per stem reflects its state

2. **Rate lock/unlock system**
   - Locked: Stem follows parent rate changes (current behavior)
   - Unlocked: Stem has independent rate, parent changes don't affect it
   - Lock button visual state (ðŸ”’ locked, ðŸ”“ unlocked)
   - Save locked/unlocked state per stem

3. **Independent rate adjustment**
   - When unlocked: Rate slider only affects that stem
   - Rate presets (0.5x/1x/2x) only affect that stem when unlocked
   - BPM display updates per stem's rate

**Implementation Locations**:
- `src/core/app.js` functions:
  - `toggleMultiStemPlay(stemType)` - lines ~2531-2549
  - `toggleStemRateLock(stemType)` - needs implementation
  - `handleStemRateChange(stemType, value)` - lines ~2613-2644
  - `setStemRatePreset(stemType, rate)` - needs implementation

### Phase 2: Independent Loop Regions
**Priority**: HIGH - Key feature

**Current State**:
- Loop button exists per stem: `toggleMultiStemLoop(stemType)`
- Parent has loop region system with visual overlay
- Stems currently follow parent loop only

**What Needs Implementation**:
1. **Per-stem loop region state**
   ```javascript
   // Add to app.js state
   let stemLoopStates = {
       vocals: { enabled: false, start: 0, end: 0 },
       drums: { enabled: false, start: 0, end: 0 },
       bass: { enabled: false, start: 0, end: 0 },
       other: { enabled: false, start: 0, end: 0 }
   };
   ```

2. **Loop region UI per stem**
   - Visual overlay on stem waveform (like parent)
   - Click-to-set loop points on stem waveform
   - Loop start/end time display per stem

3. **Loop controls per stem**
   - Loop toggle button enables/disables loop for that stem
   - Shift left/right buttons to adjust loop points
   - Half/Double buttons to adjust loop length
   - Expand/shrink controls per stem

4. **Independent loop playback**
   - When stem loop enabled: that stem loops at its points
   - Other stems unaffected by one stem's loop
   - Parent loop and stem loops can be different

**Implementation Pattern** (copy from parent):
- Parent loop code: lines ~3700-4000 (loop region rendering, controls)
- Copy and adapt for per-stem implementation

### Phase 3: Independent Markers
**Priority**: MEDIUM - Quality of life

**Current State**:
- Parent has markers with frequency selector (bar/beat intervals)
- Parent has shift controls to align markers
- Stems follow parent markers only

**What Needs Implementation**:
1. **Per-stem marker state**
   ```javascript
   let stemMarkerStates = {
       vocals: {
           enabled: true,
           frequency: 'bar',
           offset: 0,
           markers: []
       },
       // ... drums, bass, other
   };
   ```

2. **Marker controls per stem** (add to stem player UI)
   - Marker frequency selector (Every bar, 2 bars, beat, etc.)
   - Shift left/right buttons to adjust marker offset
   - Toggle markers on/off per stem

3. **Visual markers on stem waveforms**
   - Red bar markers at calculated positions
   - Orange beat markers (if beat frequency selected)
   - Markers update when frequency or offset changes

**Implementation Pattern**:
- Parent marker code: lines ~3200-3600
- `renderMarkers()` function
- Copy and adapt for per-stem markers

### Phase 4: Independent Cycle Mode
**Priority**: MEDIUM - Advanced feature

**Current State**:
- Parent has cycle mode (sets loop and starts playing)
- Parent has cycle controls (clear, seek on click, jump, preserve, etc.)
- Stems follow parent cycle only

**What Needs Implementation**:
1. **Per-stem cycle mode state**
   ```javascript
   let stemCycleModes = {
       vocals: { enabled: false, autoPlay: false },
       // ... drums, bass, other
   };
   ```

2. **Cycle mode button per stem**
   - Enable/disable cycle mode
   - When enabled: clicking waveform sets loop and plays
   - Visual feedback (button state)

3. **Cycle mode behavior per stem**
   - In cycle mode: click sets loop start, drag to end, auto-plays
   - Out of cycle mode: normal seek behavior
   - Each stem has independent cycle mode state

### Phase 5: Keyboard Shortcuts for Active Stem
**Priority**: LOW - Nice to have

**Current State**:
- All keyboard shortcuts affect parent player only
- No concept of "active" or "selected" stem

**What Needs Implementation**:
1. **Active stem selection**
   - Click on stem player bar to make it "active"
   - Visual feedback (highlight active stem bar)
   - One stem active at a time (or parent)

2. **Keyboard shortcuts affect active stem**
   - If parent active: shortcuts affect parent (current behavior)
   - If stem active: shortcuts affect that stem
   - Key mappings:
     - Space: Play/pause active stem
     - Shift+Left/Right: Move loop start of active stem
     - Shift+Up/Down: Move loop end of active stem
     - Up/Down: Half/double loop length of active stem
     - M: Toggle markers for active stem
     - C: Toggle cycle mode for active stem
     - L: Toggle loop for active stem

**Implementation Location**:
- Keyboard handler: lines ~5600-5900
- Add stem selection logic before keyboard actions

---

## Technical Approach

### State Management Strategy
Currently parent player uses global variables:
```javascript
let loopStart = 0;
let loopEnd = 0;
let loopEnabled = false;
let currentMarkers = [];
let barStartOffset = 0;
// etc.
```

For stems, create parallel state objects:
```javascript
let stemStates = {
    vocals: {
        loopStart: 0,
        loopEnd: 0,
        loopEnabled: false,
        markers: [],
        markerFrequency: 'bar',
        barStartOffset: 0,
        cycleMode: false,
        rateLocked: true,
        independentRate: 1.0
    },
    // drums, bass, other...
};
```

### UI Integration Strategy
1. **Option A**: Add controls to existing stem bars
   - Expand stem-player-rate-row with more controls
   - Add marker/cycle controls below rate controls
   - Advantage: All controls in one place
   - Disadvantage: Stems become very tall

2. **Option B**: Collapsible advanced controls per stem
   - Basic controls visible (play/mute/volume/rate)
   - "Show More" button reveals loop/marker/cycle controls
   - Advantage: Cleaner UI, progressive disclosure
   - Disadvantage: Extra click to access advanced features

3. **Option C** (Recommended): Context menu or modal per stem
   - Right-click stem or click "âš™ï¸" button
   - Opens stem-specific controls panel/modal
   - Advantage: Doesn't clutter main UI
   - Disadvantage: Controls hidden behind action

### Code Duplication vs. Abstraction
Parent player has ~800 lines of loop/marker/cycle code. Rather than duplicating:

**Option 1**: Create reusable functions
```javascript
function createLoopRegion(wavesurfer, loopState) { ... }
function renderMarkers(wavesurfer, markerState) { ... }
```

**Option 2**: Create a PlayerController class
```javascript
class PlayerController {
    constructor(wavesurfer, type, name) { ... }
    setLoop(start, end) { ... }
    toggleCycle() { ... }
    renderMarkers() { ... }
}

const parentController = new PlayerController(wavesurfer, 'parent', 'Parent');
const vocalsController = new PlayerController(stemWS.vocals, 'stem', 'Vocals');
```

**Recommendation**: Start with Option 1 (functions), refactor to Option 2 (class) in Phase 6 modularization.

---

## Files to Modify

### Primary Implementation File
- `src/core/app.js` (main implementation)
  - Add stemStates object
  - Implement per-stem loop functions
  - Implement per-stem marker functions
  - Implement per-stem cycle functions
  - Update keyboard handler for active stem

### UI Files (if adding controls)
- `index.html` - May need to add control containers to stem bars (or keep template-generated)
- `styles/stems.css` - Style new controls, active state, expanded controls

### Template System (minimal changes)
- `src/core/playerTemplate.js` - Template already supports all controls, minimal/no changes needed

---

## Testing Checklist

### Phase 1 Testing: Playback & Rate
- [ ] Each stem can play independently
- [ ] Each stem can pause independently
- [ ] Rate lock button toggles locked/unlocked state
- [ ] When locked: Parent rate change affects stem
- [ ] When unlocked: Parent rate change doesn't affect stem
- [ ] When unlocked: Stem rate slider only affects that stem
- [ ] Rate presets work per stem when unlocked
- [ ] BPM display updates per stem's rate

### Phase 2 Testing: Loop Regions
- [ ] Can set loop points per stem (click on waveform)
- [ ] Loop toggle button enables/disables loop per stem
- [ ] Loop visual overlay appears on stem waveform
- [ ] Loop start/end times display per stem
- [ ] Stem loops independently (other stems unaffected)
- [ ] Parent loop and stem loops can be different
- [ ] Loop manipulation controls work per stem

### Phase 3 Testing: Markers
- [ ] Can toggle markers on/off per stem
- [ ] Marker frequency selector works per stem
- [ ] Markers render on stem waveform at correct positions
- [ ] Shift controls adjust markers per stem
- [ ] Each stem can have different marker frequency
- [ ] Each stem can have different marker offset

### Phase 4 Testing: Cycle Mode
- [ ] Cycle button toggles cycle mode per stem
- [ ] In cycle mode: click sets loop and plays that stem
- [ ] Each stem can have independent cycle mode
- [ ] Cycle mode visual feedback per stem

### Phase 5 Testing: Keyboard Shortcuts
- [ ] Can select active stem (visual feedback)
- [ ] Space toggles play/pause for active stem
- [ ] Loop shortcuts affect active stem
- [ ] Marker shortcuts affect active stem
- [ ] Cycle shortcut affects active stem

---

## Success Criteria

Version 27 is complete when:
1. âœ… Each stem can play/pause independently
2. âœ… Each stem can have independent rate (when unlocked)
3. âœ… Each stem can have independent loop regions
4. âœ… Each stem can have independent markers
5. âœ… Each stem can have independent cycle mode
6. âœ… Keyboard shortcuts work for active stem
7. âœ… All functionality tested and working
8. âœ… User confirms: "All stem players now have full parent functionality"

---

## Starting Point for Next Session

**Branch**: Create `experimental-v27-stem-independence` from `experimental-v26-refactor`

**First Tasks**:
1. Read this handoff document completely
2. Create new branch: `git checkout -b experimental-v27-stem-independence`
3. Start with Phase 1: Independent playback & rate control
4. Test incrementally after each phase
5. Commit frequently with descriptive messages

**Key Files to Examine**:
- `src/core/app.js` lines 2313-2644 (multi-stem player code)
- `src/core/app.js` lines 3700-4000 (parent loop code - to copy/adapt)
- `src/core/app.js` lines 3200-3600 (parent marker code - to copy/adapt)
- `src/core/app.js` lines 5600-5900 (keyboard handler - to extend)

**User Quote to Remember**:
> "Taking all of the functionality we have for our bottom player and applying it to all four of the stem players."

This means FULL feature parity: loop regions, markers, cycle mode, independent rate, keyboard shortcuts - everything the parent player can do, each stem should be able to do independently.

---

## Questions for User (Before Starting)

1. **UI Preference**: How should advanced controls be presented?
   - Expand stem bars vertically with all controls?
   - Collapsible "Show More" section per stem?
   - Right-click context menu or modal per stem?

2. **Keyboard Shortcuts**: How should user select active stem?
   - Click on stem bar to make it active?
   - Number keys 1-4 to select stems, 0 for parent?
   - Tab key to cycle through stems?

3. **Priority**: Which phases are most important?
   - Phase 1 (play/rate) seems essential
   - Phase 2 (loops) seems essential
   - Phase 3-5 (markers/cycle/keyboard) - which are most valuable?

4. **Synchronization**: Should there be a "sync all stems" button?
   - Copy parent loop to all stems?
   - Copy parent markers to all stems?
   - Copy parent rate to all stems?

---

**End of Handoff**

Next session: Start with Phase 1 and incrementally build toward full stem independence.
