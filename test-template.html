<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Template Test Suite</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #eee;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4a9eff;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .test-section {
            background: #222;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .test-title {
            color: #ffa500;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .test-result {
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-size: 14px;
        }

        .test-result.pass {
            background: #1a4d1a;
            border-left: 4px solid #4CAF50;
        }

        .test-result.fail {
            background: #4d1a1a;
            border-left: 4px solid #f44336;
        }

        .generated-html {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-label {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>🧪 Player Template Test Suite</h1>
    <div id="test-results"></div>
    <div class="stats" id="stats"></div>

    <script type="module">
        import { generatePlayerHTML, controlDefinitions, getRowControls } from './src/core/playerTemplate.js';

        const results = [];
        let passCount = 0;
        let failCount = 0;

        function test(name, fn) {
            try {
                const result = fn();
                if (result.pass) {
                    passCount++;
                    results.push({
                        name,
                        status: 'pass',
                        message: result.message || 'Test passed',
                        output: result.output
                    });
                } else {
                    failCount++;
                    results.push({
                        name,
                        status: 'fail',
                        message: result.message || 'Test failed',
                        output: result.output
                    });
                }
            } catch (error) {
                failCount++;
                results.push({
                    name,
                    status: 'fail',
                    message: `Error: ${error.message}`,
                    output: error.stack
                });
            }
        }

        // ============================================
        // TEST 1: Generate Parent Player HTML
        // ============================================
        test('Generate Parent Player HTML', () => {
            const html = generatePlayerHTML('parent');
            const hasPlayButton = html.includes('id="playPauseBtn"');
            const hasWaveform = html.includes('id="waveform"');
            const hasVolumeSlider = html.includes('id="volumeSlider"');
            const hasRateControls = html.includes('id="rateSlider"');

            return {
                pass: hasPlayButton && hasWaveform && hasVolumeSlider && hasRateControls,
                message: hasPlayButton && hasWaveform && hasVolumeSlider && hasRateControls
                    ? '✅ Parent player HTML generated with all expected controls'
                    : '❌ Missing expected controls in parent player HTML',
                output: html
            };
        });

        // ============================================
        // TEST 2: Generate Stem Player HTML
        // ============================================
        test('Generate Stem Player HTML (vocals)', () => {
            const html = generatePlayerHTML('stem', { stemType: 'vocals' });
            const hasPlayButton = html.includes('stem-play-pause-vocals');
            const hasMuteButton = html.includes('stem-mute-vocals');
            const hasWaveform = html.includes('stem-waveform-vocals');
            const hasRateLock = html.includes('stem-rate-lock-vocals');

            return {
                pass: hasPlayButton && hasMuteButton && hasWaveform && hasRateLock,
                message: hasPlayButton && hasMuteButton && hasWaveform && hasRateLock
                    ? '✅ Stem player HTML generated with all expected controls'
                    : '❌ Missing expected controls in stem player HTML',
                output: html
            };
        });

        // ============================================
        // TEST 3: Control Count Verification
        // ============================================
        test('Control Count Verification', () => {
            const totalControls = Object.keys(controlDefinitions).length;
            const parentMainControls = getRowControls('main', 'parent').length;
            const parentRateControls = getRowControls('rate', 'parent').length;
            const stemMainControls = getRowControls('main', 'stem').length;
            const stemRateControls = getRowControls('rate', 'stem').length;

            const output = `
Total control definitions: ${totalControls}
Parent main row controls: ${parentMainControls}
Parent rate row controls: ${parentRateControls}
Stem main row controls: ${stemMainControls}
Stem rate row controls: ${stemRateControls}
            `.trim();

            return {
                pass: totalControls === 15,
                message: totalControls === 15
                    ? `✅ Expected 15 control definitions, found ${totalControls}`
                    : `❌ Expected 15 control definitions, found ${totalControls}`,
                output
            };
        });

        // ============================================
        // TEST 4: ID Uniqueness Check
        // ============================================
        test('ID Uniqueness Check', () => {
            const parentHTML = generatePlayerHTML('parent');
            const vocalsHTML = generatePlayerHTML('stem', { stemType: 'vocals' });
            const drumsHTML = generatePlayerHTML('stem', { stemType: 'drums' });

            const allHTML = parentHTML + vocalsHTML + drumsHTML;
            const idMatches = allHTML.match(/id="([^"]+)"/g) || [];
            const ids = idMatches.map(match => match.match(/id="([^"]+)"/)[1]);
            const uniqueIds = new Set(ids);

            const hasDuplicates = ids.length !== uniqueIds.size;
            const duplicates = hasDuplicates
                ? ids.filter((id, index) => ids.indexOf(id) !== index)
                : [];

            return {
                pass: !hasDuplicates,
                message: !hasDuplicates
                    ? `✅ All ${ids.length} IDs are unique across parent and stem players`
                    : `❌ Found duplicate IDs: ${duplicates.join(', ')}`,
                output: `Total IDs: ${ids.length}\nUnique IDs: ${uniqueIds.size}`
            };
        });

        // ============================================
        // RENDER RESULTS
        // ============================================
        const resultsContainer = document.getElementById('test-results');
        const statsContainer = document.getElementById('stats');

        results.forEach(result => {
            const section = document.createElement('div');
            section.className = 'test-section';

            const title = document.createElement('div');
            title.className = 'test-title';
            title.textContent = result.name;

            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${result.status}`;
            resultDiv.textContent = result.message;

            section.appendChild(title);
            section.appendChild(resultDiv);

            if (result.output) {
                const output = document.createElement('div');
                output.className = 'generated-html';
                output.textContent = typeof result.output === 'string'
                    ? result.output
                    : JSON.stringify(result.output, null, 2);
                section.appendChild(output);
            }

            resultsContainer.appendChild(section);
        });

        // Render stats
        const totalTests = passCount + failCount;
        const passRate = Math.round((passCount / totalTests) * 100);

        statsContainer.innerHTML = `
            <div class="stat-item">
                <div class="stat-value">${totalTests}</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #4CAF50">${passCount}</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #f44336">${failCount}</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${passRate}%</div>
                <div class="stat-label">Pass Rate</div>
            </div>
        `;

        console.log(`✅ Tests complete: ${passCount} passed, ${failCount} failed`);
    </script>
</body>
</html>
